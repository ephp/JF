{% extends '::base.html.twig' %}

{% block ready_js %}
$('#fast_search').keyup(function(){
    fastSearch();
});

$('span.label').click(function() {
    var tr = $(this).closest('tr');
    $('#cambia_priorita_a').text(tr.attr('titolo'));
    $('#priorita_id').val(tr.attr('id'));
    $('#priorita_priorita').val(tr.attr('priorita'));
    $('#bt_cambia_priorita').show();
    $('#wait_cambia_priorita').hide();
});
{% endblock ready_js %}
{% block inline_js %}
function fastSearch() {
    var q = $('#fast_search').val().trim().toLowerCase();
    if(q.trim() == '') {
        $('.fast_search').show();
    } else {
        $('.fast_search').hide();
        $('.fast_search').each(function(){
            if($(this).attr('name').toLowerCase().search(q) >=0) {
                $(this).show();
            }
        });
    }
}

function assegnaPriorita() {
    $('#bt_cambia_priorita').hide();
    $('#wait_cambia_priorita').show();
    var form = $('#cambia_priorita');
    $.post(Routing.generate('claims_hospital_audit_cambia_priorita'), form.serialize(), function(out) {
        var riga = $('#' + $('#priorita_id').val());
        var label = riga.find('.label');
        var abbr = label.find('abbr');
        label = riga.find('.label');
        label.removeClass('label-normal')
                .removeClass('label-info')
                .removeClass('label-green')
                .removeClass('label-warning')
                .removeClass('label-important')
                .removeClass('label-success')
                .addClass(out.css);
        riga.attr('priorita', out.id);
        abbr.attr('title', out.label);
        abbr.html(out.label);
        $.fancybox.close();
    });
}
{% endblock inline_js %}

{% block body -%}
<div class="page-header">
    <div class="icon">
        <span class="ico-eye-open"></span>
    </div>
    <h1>Audit Hospital<small>{{ entity.luogo }} - {{ entity.giorno|date('d/m/Y') }}</small></h1>
    <div class="icon green right white">
        <a target="_blank" href="{{ path('claims-h-audit-xls', query)}}"><span class="ico-table" title="Esporta Excel"></span></a>
    </div>
    {% if jf_mode == 'offline' %}
        <div class="icon blue right white">
            <a target="_blank" href="{{ path('sync_claims-h-audit-fetch-audit', { 'id': entity.remoteId }) }}"><span class="ico-download-alt" title="load from server"></span></a>
        </div>
    {% endif %}
</div>
<div class="row-fluid">
    <div class="span12">
        <div class="block">
            <div class="data-fluid">
                <a href="{{ path('claims-h-audit_show', query|merge({'id': entity.id})) }}"><span class="label label-success" style="margin-bottom: 3px;">Claims</span></a>
                <a href="{{ path('claims-h-audit_risposte', query|merge({'id': entity.id})) }}"><span class="label label-green" style="margin-bottom: 3px;">Excel preview</span></a>
                <a href="#fb_ricerca" class="fancybox"><span class="label label-info ico-search" style="margin-bottom: 3px;">&nbsp;Ricerca</span></a>
            </div>
        </div>
    </div>
</div>
{% render(controller("ClaimsHAuditBundle:Render:ricerca", {'id': entity.id, 'route': route, 'ricerca': ricerca})) %}
{% if sorting is defined %}
    <div class="row-fluid">
        <div class="span12">
            <div class="block">
                <div class="data-fluid">
                    {% for sortmode, link in sorting %}
                        <a href="{{ path(app.request.get('_route'), query|merge({'sorting': link.mode})) }}"><span class="label {% if app.user.dati.claims_haudit_sorting == sortmode or app.user.dati.claims_haudit_sorting == 'i'~sortmode %}label-success{% else %}label-green{% endif %} {% if link.icon is defined %}{{ link.icon }}{% endif %}" style="margin-bottom: 3px;">{% if link.icon is defined %}&nbsp;{% endif %}{{ link.label }}</span></a>
                    {% endfor %}
                </div>            
            </div>            
        </div>       
    </div> 
{% endif %}
{% set span = 4 %}
{% for domanda in entity.sumQuestion %}
    {% if loop.index % 3 == 1 %}
    <div class="row-fluid">
        {% if loop.length - loop.index == 1 %}
            {% set span = 6 %}
        {% endif %}
        {% if loop.length - loop.index == 0 %}
            {% set span = 12 %}
        {% endif %}
    {% endif %}
        <div class="span{{ span }}">
            <div class="block">
                <div class="audit padding-10" style="border: 1px solid #c9c9c9; background: #e9e9e9;">
                    <b>{{ domanda.question.domandaLocale(app.user.locale) }}</b><br/>
                    {{ domanda.value|number_format(2, ',', '.') }} €
                    <small>({{domanda.n}} claims)</small>
                </div>
            </div>
        </div>
    {% if loop.index % 3 == 0 or loop.last %}
        </div>
    {% endif %}
{% endfor %}
<div class="row-fluid">
    <div class="span12">
        <div class="block">
            <div class="data-fluid">
                <table class="table grid" cellpadding="0" cellspacing="0" width="100%">
                    <thead>
                        <tr>
                            <th width="40">#</th>
                            <th>Group</th>
                            <th>TPA</th>
                            <th><input type="text" id="fast_search" style="width: 200px;" placeholder="Claimant"></th>
                            <th>Reserve</th>
                            <th>Proirity</th>
                            {% for question in entity.sumQuestion %}
                                {% set name = question.question.esempioLocale(app.user.locale) %}
                                <th>{{ name }}</th>
                            {% endfor %}
                            <th>Progress</th>
                            <th width="80" class="TAC">Op.</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for pratica in pratiche %}
                        <tr name="{{ pratica.claimant }}" class='fast_search' id="{{ pratica.slug }}" titolo="{{ pratica }}" priorita="{% if pratica.priorita %}{{ pratica.priorita.id }}{% endif %}">                            
                            <td>{{ loop.index }}</td>
                            <td>{{ pratica.gruppo }}</td>
                            <td>{{ pratica.codice }}</td>
                            <td>{{ pratica.claimant }}</td>
                            <td nowrap style="text-align: right;">{{ pratica.reserve }} €</td>
                            <td style="text-align: center">
                                <a href="#fb_cambia_priorita" class="fancybox">
                                    {% if pratica.priorita %}
                                        <span class="label {{ pratica.priorita.css }}">
                                            <abbr title="{{ pratica.priorita.priorita }}">{{ pratica.priorita.priorita }}</abbr>
                                        </span>
                                    {% else %}
                                        <span class="label purple">
                                            <abbr title="Not defined">Not defined</abbr>
                                        </span>
                                    {% endif %}
                                </a>
                            </td>
                            {% set name = '' %}
                            {% for question in entity.sumQuestion %}
                                {% set values = pratica.values(question.question.id) %}
                                <td nowrap style="text-align: right;">
                                    {% if values %}
                                        {% for value in values.response %}
                                            {{ value }} €
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            {% endfor %}
                            <td>{{ pratica.question01 }}/{{ entity.question|length }}</td>
                            <td>
                                {% include ":commons:show.html.twig" with {'route': path('claims-h-audit_show-pratica', { 'id': entity.id, 'slug': pratica.slug })} %}
                                {% if jf_mode == 'offline' %}
                                    {% if pratica.priorita and pratica.priorita.priorita == 'Aggiornato' %}
                                        {% include ":commons:upload.html.twig" with {'route': path('sync_claims-h-audit-pull-p', { 'id': pratica.id })} %}                    
                                    {% else %}
                                        {% include ":commons:download.html.twig" with {'route': path('sync_claims-h-audit-fetch-p', { 'id': pratica.id })} %}                    
                                    {% endif %}
                                {% endif %}
                                {% if jf_mode == 'online' %}
                                    {% include ":commons:delete.html.twig" with {'route': path('claims-h-audit_pratica-delete', { 'id': pratica.id }), 'disable': not app.user.hasRole('C_AUDIT_HC'), 'question': 'You want to delete ' ~ pratica.claimant } %}
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% render(controller("ClaimsHAuditBundle:Render:cambiaPriorita")) %}
{% endblock %}
